# tsa

*Guard your REST API with a bit of fascism.*

TSA is a node.js library designed to take JSON input and:
* filter it against a whitelist
* validate it *(todo)*
* transform it *(todo)*
* provide default values to it *(todo)*

It has been designed with usage in an Express-based JSON REST API in mind, and allows you to easily pass it into your route as middleware.

## Installation

```bash
$ npm install tsa
```

## Usage

### Basic Scenario

Create a guard:

```javascript
var tsa = require('tsa');
var guard = tsa({
    property1: tsa.required()
  , property2: tsa.optional()
});
```

Validate input against guard:

```javascript
var input = {
    property1: 'foo'
  , property3: 'bar'
};
guard.frisk(input, function(err, result){
  // err is null
  // result.property1 === 'foo'
  // result.property2 === undefined
  // there is no key result.property3 because it isn't in the whitelist
});
```

### Express Middleware

Create a guard:

```javascript
var tsa = require('tsa');
var guard = tsa({
    property1: tsa.required()
  , property2: tsa.optional()
});
```

Ensure you're using express's body parser:

```javascript
app.use(express.bodyParser());
```

Add that guard's middleware to your route:

```javascript
app.post('/foo', guard.middleware(), function(req, res){
  // req.tsa is the whitelisted, validated, transformed version of the input from req.body
});

app.error(function(err, req, res, next){
  // err is an array of errors generated by the guard
});
```

### Nested Guards

```javascript
var tsa = require('tsa');
var address = tsa({
    street1: tsa.required()
  , street2: tsa.optional()
});
var person = tsa({
    name: tsa.required()
  , address: address
});
```

### Required Field

```javascript
var tsa = require('tsa');
var guard = tsa({
  property1: tsa.required()
});
var input = {};
guard.frisk(input, function(err, result){
  // err === instanceof Array
  // err[0] === 'required field property1 not supplied'
});
```

### Optional Field

```javascript
var tsa = require('tsa');
var guard = tsa({
  property1: tsa.optional()
});
var input = {};
guard.frisk(input, function(err, result){
  // err === null
  // result === {}
});
```

### Whitelisting

```javascript
var tsa = require('tsa');
var guard = tsa({
  property1: tsa.required()
});
var input = {
    property1: 'foo'
  , property2: 'bar'
};
guard.frisk(input, function(err, result){
  // result.property1 === 'foo'
  // result has no property2 key
});
```

### Custom Validations

*TODO*

### Default Values

```javascript
var tsa = require('tsa');
var guard = tsa({
  foo: tsa.field({default: 'bar'})
});
var input = {};
guard.frisk(input, function(err, result){
  // err === null
  // result.foo === 'bar'
});
```

Optionally, the default value can be a function which will be executed by tsa:

```javascript
var tsa = require('tsa');
var now = function(){
  return new Date();
};
var guard = tsa({
  foo: tsa.field({default: now})
});
var input = {};
guard.frisk(input, function(err, result){
  // err === null
  // result.foo === a Date object
});
```

### Transformations

```javascript
var tsa = require('tsa');
var toUpper = function(input, cb){
  cb(null, input.toUpperCase());
};
var guard = tsa({
  foo: tsa.field({transform: toUpper})
});
var input = { foo: 'bar' };
guard.frisk(input, function(err, result){
  // err === null
  // result.foo === 'BAR'
});
```

## Test

Run tests via mocha:

```bash
$ npm install -g mocha
$ git clone git://github.com/TroyGoode/node-tsa.git tsa
$ cd tsa/
$ npm install
$ mocha
```

Run example web app:

```bash
$ git clone git://github.com/TroyGoode/node-tsa.git tsa
$ cd tsa/
$ npm install
$ cd example/
$ npm install
$ node app.js
$ open http://localhost:3000
```

## License

[MIT License](http://www.opensource.org/licenses/mit-license.php)

## Author

[Troy Goode](https://github.com/TroyGoode) ([troygoode@gmail.com](mailto:troygoode@gmail.com))
